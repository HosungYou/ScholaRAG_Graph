# Session Log: BUG-035~039, PERF-010, UI-002 Fixes

> **Session ID**: 2026-01-21_bug-035-039-perf-010-ui-002
> **Date**: 2026-01-21T04:30:00Z
> **Agent**: Opus 4.5
> **Type**: bugfix-performance-ui
> **Duration**: 90 minutes

---

## Context

### User Reports
1. **메모리 초과 재발**: PERF-009 적용 후에도 Render 서버 메모리 초과로 재시작
2. **Resume 버그**: "Cannot resume: Checkpoint is missing project_id" 에러 발생
3. **HTTP 400 Bad Request**: POST `/api/import/resume/{job_id}` 실패
4. **중단된 Import 미표시**: 프로젝트 목록에 중단된 Import가 표시되지 않음

---

## Root Cause Analysis

### BUG-035: Checkpoint Missing project_id
- **문제**: checkpoint가 import 진행 중에 저장되지만, project_id는 import 완료 후에야 설정됨
- **코드 흐름**:
  1. `current_project_id = existing_project_id` (새 import 시 None)
  2. progress callback마다 checkpoint 저장 (project_id = None)
  3. import 완료 후에야 `current_project_id` 업데이트
- **결과**: checkpoint에 project_id가 없어서 Resume 실패

### PERF-009 부족: Memory Still Exceeded
- batch_size = 20으로도 512MB 메모리 초과
- Cohere/OpenAI embedding 호출 시 메모리 급증

### BUG-036: INTERRUPTED Status Not in list_import_jobs
- **문제**: `list_import_jobs` 엔드포인트의 `status_map`에 `INTERRUPTED` 상태가 누락
- **결과**: interrupted 상태의 job이 pending으로 표시되어 프론트엔드에서 필터링 안 됨

### BUG-037: metadata Field Missing in ImportJobResponse
- **문제**: `ImportJobResponse`에 `metadata` 필드가 없음
- **결과**: 프론트엔드가 `project_name`, `checkpoint` 정보를 받을 수 없음

### BUG-038: Cohere Embedding Error with Empty Message
- **문제**: Cohere API 호출이 점점 느려지다가 에러 발생 (빈 에러 메시지)
- **로그 분석**:
  - API 응답 시간: 0.25s → 0.5s → 5s → 11s → 31s (지수적 증가)
  - DB TimeoutError 발생 (connection pool exhaustion)
  - `ERROR:llm.cohere_embeddings:Cohere embedding error:` (빈 메시지)
- **원인**:
  - Cohere API 레이트 리밋 또는 네트워크 문제로 응답 지연
  - 긴 API 호출이 asyncio 이벤트 루프 블로킹
  - DB 커넥션 풀 고갈로 인한 타임아웃

---

## Solutions Applied

### BUG-035 Fix: Update Checkpoint with project_id

**File**: `backend/routers/import_.py`

import 완료 후 checkpoint를 명시적으로 업데이트:

```python
# BUG-035 FIX: Update checkpoint with project_id immediately
try:
    existing_job = await job_store.get_job(job_id)
    if existing_job and existing_job.metadata.get("checkpoint"):
        checkpoint = existing_job.metadata["checkpoint"]
        checkpoint["project_id"] = current_project_id
        await job_store.update_job(
            job_id=job_id,
            metadata={"checkpoint": checkpoint},
        )
except Exception as e:
    logger.warning(f"Failed to update checkpoint with project_id: {e}")
```

### PERF-010: Aggressive Memory Optimization

| File | Before | After |
|------|--------|-------|
| `cohere_embeddings.py` | batch_size = 20 | batch_size = 5 |
| `openai_embeddings.py` | batch_size = 20 | batch_size = 5 |
| `embedding_pipeline.py` | batch_size = 20 | batch_size = 5 |
| `graph_store.py` | batch_size = 20 | batch_size = 5 |
| `config.py` | cache_max_size = 100 | cache_max_size = 50 |

### BUG-036 Fix: Add INTERRUPTED to status_map

**File**: `backend/routers/import_.py`

```python
# BUG-036 FIX: Include INTERRUPTED status in mapping
status_map = {
    JobStatus.PENDING: ImportStatus.PENDING,
    JobStatus.RUNNING: ImportStatus.PROCESSING,
    JobStatus.COMPLETED: ImportStatus.COMPLETED,
    JobStatus.FAILED: ImportStatus.FAILED,
    JobStatus.CANCELLED: ImportStatus.FAILED,
    JobStatus.INTERRUPTED: ImportStatus.INTERRUPTED,  # Added
}
```

### BUG-037 Fix: Add metadata to ImportJobResponse

**File**: `backend/routers/import_.py`

```python
class ImportJobResponse(BaseModel):
    # ... existing fields ...
    # UI-002: Added metadata for interrupted jobs display (project_name, checkpoint)
    metadata: Optional[dict] = None
```

### UI-002: Interrupted Imports Section

**Files**:
- `frontend/app/projects/page.tsx` - Added `InterruptedImportsSection` component
- `frontend/lib/api.ts` - Added `getImportJobs()` API method
- `frontend/types/graph.ts` - Updated `ImportJob` type

Features:
- 중단된 Import 목록을 프로젝트 페이지 상단에 표시
- 각 항목에 Resume 버튼 제공
- 날짜와 시간(HH:MM) 표시
- 진행률 표시
- 한국어 UI

### BUG-038 Fix: Cohere Embedding Timeout and Error Handling

**Files**:
- `backend/llm/cohere_embeddings.py`
- `backend/graph/embedding/embedding_pipeline.py`

**Changes**:
```python
# 1. Add 30-second timeout to Cohere API calls
response = await asyncio.wait_for(
    self.client.embed(**embed_kwargs),
    timeout=30.0  # 30 second timeout per batch
)

# 2. Track and abort on 3+ slow calls (>10s)
if elapsed > 10.0:
    slow_call_count += 1
    if slow_call_count >= max_slow_calls:
        raise RuntimeError(f"Cohere API rate limited ({slow_call_count} slow calls)")

# 3. Better error logging with exception type
error_type = type(e).__name__
error_msg = str(e) if str(e) else "(no message)"
logger.error(f"Cohere embedding error ({error_type}): {error_msg}")
```

### BUG-039 Fix: DB Retry Logic for Job Persistence

**File**: `backend/jobs/job_store.py`

**Problem**: DB 연결 타임아웃 시 job이 메모리에만 저장되어 서버 재시작 시 데이터 손실

**Solution**:
```python
# Exponential backoff retry (3 attempts: 0.5s → 1s → 2s)
MAX_RETRIES = 3
RETRY_DELAY_BASE = 0.5

async def _db_execute_with_retry(self, operation_name: str, query: str, *args) -> bool:
    for attempt in range(MAX_RETRIES):
        try:
            await self.db.execute(query, *args)
            return True
        except Exception as e:
            if attempt < MAX_RETRIES - 1:
                delay = RETRY_DELAY_BASE * (2 ** attempt)
                logger.warning(f"DB {operation_name} failed, retry {attempt + 1}/{MAX_RETRIES} in {delay}s")
                await asyncio.sleep(delay)
    return False
```

**적용 위치**:
- `create_job()` - 새 job 생성 시
- `update_job()` - checkpoint 저장 등 업데이트 시

---

## Commits

| Commit | Description |
|--------|-------------|
| `2394469` | fix(BUG-035): Update checkpoint with project_id after import completes |
| `9d71050` | fix(UI-002): Add missing TypeScript types for ImportJob |
| `b184edc` | fix(BUG-036, BUG-037): Fix interrupted imports not showing in list |
| `1074966` | fix(BUG-038): Improve Cohere embedding error handling and timeouts |
| `b63270d` | fix(BUG-039): Add DB retry logic for job persistence |

---

## Files Modified

| File | Change |
|------|--------|
| `backend/routers/import_.py` | BUG-035, BUG-036, BUG-037 fixes |
| `backend/llm/cohere_embeddings.py` | PERF-010: batch_size 20 → 5 |
| `backend/llm/openai_embeddings.py` | PERF-010: batch_size 20 → 5 |
| `backend/graph/embedding/embedding_pipeline.py` | PERF-010: batch_size 20 → 5 |
| `backend/graph/graph_store.py` | PERF-010: batch_size 20 → 5 |
| `backend/config.py` | PERF-010: cache_max_size 100 → 50 |
| `frontend/app/projects/page.tsx` | UI-002: InterruptedImportsSection 추가 |
| `frontend/lib/api.ts` | UI-002: getImportJobs() 추가 |
| `frontend/types/graph.ts` | UI-002: ImportJob 타입 확장 |

---

## Why Interrupted Imports Don't Show

### Current Situation
중단된 Import가 프로젝트 목록에 표시되지 않는 이유:

1. ~~**BUG-036**: `list_import_jobs` status_map에 INTERRUPTED 누락~~ (Fixed)
2. ~~**BUG-037**: metadata 필드 누락으로 project_name 정보 없음~~ (Fixed)
3. **Render Manual Deploy 미적용**: Backend 코드 변경이 아직 배포되지 않음

### Solution
Render Dashboard에서 Manual Deploy 실행 필요:
1. Render Dashboard → `scholarag-graph-docker`
2. "Manual Deploy" → "Deploy latest commit"
3. 배포 후 서버 시작 시 `mark_running_as_interrupted()` 호출
4. DB의 `jobs` 테이블에서 RUNNING → INTERRUPTED로 상태 변경
5. Frontend에서 `/api/import/jobs?status=interrupted` 호출 시 정상 반환

---

## Deployment Required

| Service | Platform | Action | Status |
|---------|----------|--------|--------|
| Backend | Render | Manual Deploy 필요 | ⏳ Pending |
| Frontend | Vercel | Auto Deploy 진행 | ✅ Triggered |

---

## Next Steps

1. **Render Manual Deploy** 실행 (Backend)
2. **서버 재시작 확인** - logs에서 "BUG-028: Marked N interrupted import jobs" 확인
3. **프로젝트 목록 확인** - 중단된 Import 섹션 표시 확인
4. **Resume 테스트** - Resume 버튼 클릭하여 정상 작동 확인
5. **메모리 모니터링** - 60-70% 이하 유지 확인
6. **문제 지속 시**: Render 인스턴스 업그레이드 검토 ($15/월 for 1GB RAM)

---

## Session Statistics

| Metric | Value |
|--------|-------|
| Files Read | 12 |
| Files Modified | 12 |
| Commits | 5 |
| Bugs Fixed | 6 (BUG-035, BUG-036, BUG-037, BUG-038, BUG-039, UI-002 type error) |
| Performance Fixes | 1 (PERF-010) |
| UI Features | 1 (UI-002: InterruptedImportsSection) |

---

*Generated by Claude Code (Opus 4.5)*
